<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="IslandPostPOS.Views.SalesListPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:IslandPostPOS.Views"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:dtos="using:IslandPostPOS.Shared.DTOs"
    xmlns:models="using:IslandPostPOS.Models"
    xmlns:converters="using:IslandPostPOS.Converters"
    xmlns:editors="using:Syncfusion.UI.Xaml.Editors"
    xmlns:hrlpers="using:IslandPostPOS.Helpers"
    mc:Ignorable="d"
    x:Name="RootPage">

    <Page.Resources>
        <BitmapImage x:Key="DefaultProductImage" UriSource="ms-appx:///Assets/No-Image-Placeholder.png"/>
        <converters:ByteArrayToImageConverter x:Key="ByteArrayToImage"/>
        <converters:GreaterThanZeroConverter x:Key="GreaterThanZeroConverter"/>
        <UniformGridLayout x:Key="UniformGridLayout2" MinItemWidth="150" MinItemHeight="150" MinRowSpacing="12" MinColumnSpacing="12"/>
    </Page.Resources>

    <Grid Margin="100,40,0,0">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!--Sales Grid-->
        <Grid RowSpacing="10">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            <TextBlock FontWeight="Bold" Text="Search for product"/>

            <Grid Grid.Row="1" HorizontalAlignment="Stretch">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBox x:Name="ProductSearchBox"
                    PlaceholderText="Enter a product"
                    Text="{x:Bind ViewModel.SearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                    InputScope="Search">
                </TextBox>
                <Button Grid.Column="1" Content="Clear" Click="ClearButton_Click"/>
            </Grid>


            <!-- XAML Code -->

            <!-- The ItemsRepeater and ScrollViewer used: -->
            <ScrollViewer x:Name="scrollViewer"
                Grid.Row="2"
                Height="400"
                IsVerticalScrollChainingEnabled="False"
                Padding="0,0,16,0">
                <ItemsRepeater
                    ItemsSource="{x:Bind ViewModel.Service.FilteredProducts,Mode=OneWay}"
                    Layout="{StaticResource UniformGridLayout2}">
                    <ItemsRepeater.ItemTemplate>
                        <DataTemplate x:DataType="dtos:ProductDTO">
                            <Button 
                                Style="{StaticResource PayButtonStyle}"
                                Height="150" Width="150"
                                Command="{Binding DataContext.AddPurchaseItemCommand, 
                                ElementName=RootPage}" 
                                CommandParameter="{x:Bind}">
                                <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="90"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <Image Source="{x:Bind Photo, 
                                    Converter={StaticResource ByteArrayToImage}}"
                                    Height="90"/>

                                <TextBlock Grid.Row="1" Padding="10" Text="{x:Bind Description}"
                                   Foreground="{ThemeResource SystemControlForegroundChromeWhiteBrush}"
                                   HorizontalAlignment="Center" TextWrapping="Wrap"
                                   VerticalAlignment="Center"/>
                            </Grid>
                                </Button>
                        </DataTemplate>
                    </ItemsRepeater.ItemTemplate>
                </ItemsRepeater>
            </ScrollViewer>
            <!-- Loading indicator -->
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center"
                Visibility="{x:Bind ViewModel.IsSearching, Converter={StaticResource BoolToVisibility}}">
                <ProgressRing IsActive="True" Width="40" Height="40"/>
                <TextBlock Text="Searching..." Margin="0,10,0,0"/>
            </StackPanel>
        </Grid>

        <!--Sale List-->
        <Grid Margin="10,0,60,10"  Grid.Column="1" Background="white">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!--Options-->
            <Grid Padding="5">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <DropDownButton Content="Retreieve Sale" BorderThickness="0"  IsEnabled="{x:Bind ViewModel.Service.ParkedSales.Count, Mode=OneWay, Converter={StaticResource GreaterThanZeroConverter}}">
                    <DropDownButton.Flyout>
                        <Flyout Placement="Bottom">
                            <ItemsRepeater ItemsSource="{x:Bind ViewModel.Service.ParkedSales, Mode=OneWay}">
                                <ItemsRepeater.ItemTemplate>
                                    <DataTemplate x:DataType="dtos:SaleDTO">
                                        <Button Content="{x:Bind Note}"
                                        />
                                    </DataTemplate>
                                </ItemsRepeater.ItemTemplate>
                            </ItemsRepeater>

                        </Flyout>
                    </DropDownButton.Flyout>
                </DropDownButton>

                <HyperlinkButton x:Name="parkedSaleBtn"  Grid.Column="1" Content="Park Sale" Click="parkedSaleBtn_Click" IsEnabled="{x:Bind ViewModel.SaleItems.Count, Mode=OneWay, Converter={StaticResource GreaterThanZeroConverter}}"/>
                <DropDownButton  Grid.Column="2" Content="More Options" BorderThickness="0">
                    <DropDownButton.Flyout>
                        <MenuFlyout Placement="Bottom">
                            <MenuFlyoutItem Text="Send"/>
                            <MenuFlyoutItem Text="Reply"/>
                            <MenuFlyoutItem Text="Reply All"/>
                        </MenuFlyout>
                    </DropDownButton.Flyout>
                </DropDownButton>
            </Grid>

            <!--Customer SearchBar-->
            <editors:SfAutoComplete
                Margin="5"
                    Grid.Row="1"
                    HorizontalAlignment="Stretch"
                    TextMemberPath="Description"   
                                PlaceholderText="Add a customer"
                                ItemsSource="{Binding Products}" >
                <editors:SfAutoComplete.ItemTemplate>
                    <DataTemplate>
                        <Grid Height="80">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="48"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Image Grid.Column="0"
                                            Source="{Binding Photo , Converter={StaticResource ByteArrayToImage}, ConverterParameter=100}"
                                            Stretch="Uniform"/>
                            <StackPanel Grid.Column="1" Margin="10,0" VerticalAlignment="Center">
                                <TextBlock Text="{Binding Description}"/>
                            </StackPanel>
                        </Grid>
                    </DataTemplate>
                </editors:SfAutoComplete.ItemTemplate>
            </editors:SfAutoComplete>

            <!--Items-->
            <ScrollViewer Grid.Row="2"
              VerticalScrollBarVisibility="Auto"
              HorizontalScrollBarVisibility="Disabled"
              >

                <ItemsRepeater ItemsSource="{x:Bind ViewModel.SaleItems}" HorizontalAlignment="Stretch">
                    <ItemsRepeater.Layout>
                        <StackLayout Orientation="Vertical" />
                    </ItemsRepeater.Layout>

                    <ItemsRepeater.ItemTemplate>
                        <!-- Each item is a Product -->
                        <DataTemplate x:DataType="models:PurchaseItem">
                            <Expander Header="{x:Bind}" Content="{x:Bind}" HorizontalAlignment="Stretch">
                                <Expander.HeaderTemplate>
                                    <!-- Strongly typed DataTemplate -->
                                    <DataTemplate x:DataType="models:PurchaseItem">
                                        <Grid Padding="8" HorizontalAlignment="Stretch">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <!-- Item count -->
                                            <TextBlock Text="{x:Bind Quantity, Mode=OneWay}"
                                           VerticalAlignment="Center"
                                           Margin="0,0,12,0"/>

                                            <!-- Description -->
                                            <TextBlock Text="{x:Bind Description}"
                                           Grid.Column="1"
                                           VerticalAlignment="Center"
                                           Margin="0,0,12,0"/>

                                            <!-- Description -->
                                            <TextBlock Text="{x:Bind FormatAmount(Total),Mode=OneWay}"
                                                       Grid.Column="2"
                                                       VerticalAlignment="Center"
                                                       Margin="0,0,12,0"
                                                       FontWeight="Bold"
                                                       />

                                            <!-- Delete button -->
                                            <Button Grid.Column="3"
                                                    VerticalAlignment="Center"
                                                    Command="{Binding ViewModel.DeleteProductCommand, ElementName=RootPage}"
                                                    CommandParameter="{Binding}">
                                                <FontIcon Glyph="&#xE74D;"
                                              FontFamily="Segoe MDL2 Assets"/>
                                            </Button>
                                        </Grid>
                                    </DataTemplate>
                                </Expander.HeaderTemplate>
                                <Expander.ContentTemplate>
                                    <DataTemplate x:DataType="models:PurchaseItem">
                                        <Grid Width="450" ColumnSpacing="5">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>

                                            <TextBlock Text="Quantity" FontWeight="Bold" TextAlignment="Left"/>
                                            <TextBlock Grid.Column="1" Text="Price" FontWeight="Bold" TextAlignment="Left"/>
                                            <TextBlock Grid.Column="2" Text="Discount" FontWeight="Bold" TextAlignment="Left"/>

                                            <NumberBox Grid.Column="0" Grid.Row="1" SpinButtonPlacementMode="Compact" Value="{x:Bind Quantity, Mode=TwoWay,UpdateSourceTrigger=PropertyChanged}"/>
                                            <TextBox IsReadOnly="True"  Grid.Column="1" Grid.Row="1" Text="{x:Bind Price, Mode=OneWay}"/>
                                            <NumberBox Grid.Column="2" Grid.Row="1" SmallChange="5" Minimum="0" Maximum="100" SpinButtonPlacementMode="Compact" Value="{x:Bind DiscountPercent, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>

                                            <TextBlock Text="Notes" Grid.Row="2"  Grid.ColumnSpan="3" FontWeight="Bold" TextAlignment="Left"/>
                                            <TextBox Grid.Column="0" Grid.Row="3" Grid.ColumnSpan="3" Text="{x:Bind Note, Mode=TwoWay,UpdateSourceTrigger=PropertyChanged}"/>

                                            <HyperlinkButton Grid.Column="0" Grid.ColumnSpan="2" Grid.Row="4" Content="Sold By Creswell Gould"/>
                                        </Grid>
                                    </DataTemplate>
                                </Expander.ContentTemplate>
                            </Expander>
                        </DataTemplate>
                    </ItemsRepeater.ItemTemplate>
                </ItemsRepeater>
            </ScrollViewer>

            <!--Seperator-->
            <Rectangle Margin="10,0" Grid.Row="3" Height="1" Fill="{ThemeResource SystemControlBackgroundBaseLowBrush}" HorizontalAlignment="Stretch" />

            <!--ADD-->
            <Grid Grid.Row="4" Margin="10,5">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <TextBlock Text="ADD" FontWeight="Bold" VerticalAlignment="Center"/>
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <HyperlinkButton Grid.Column="1" Content="Discount"/>
                    <HyperlinkButton Grid.Column="1" Content="Promo Code" IsEnabled="False"/>
                    <HyperlinkButton Grid.Column="1" Content="Note"/>
                </StackPanel>
            </Grid>

            <!--Seperator-->
            <Rectangle Margin="10,0" Grid.Row="5" Height="1" Fill="{ThemeResource SystemControlBackgroundBaseLowBrush}" HorizontalAlignment="Stretch" />

            <!--SUBTOTAL-->
            <Grid Grid.Row="6" Margin="10,10">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <TextBlock Text="Subtotal" FontWeight="Bold" VerticalAlignment="Center"/>
                <TextBlock Grid.Column="1" Text="{x:Bind FormatAmount(ViewModel.SubTotal),Mode=OneWay}" FontWeight="Bold" HorizontalAlignment="Right"/>
            </Grid>

            <!--Seperator-->
            <Rectangle Margin="10,0" Grid.Row="7" Height="1" Fill="{ThemeResource SystemControlBackgroundBaseLowBrush}" HorizontalAlignment="Stretch" />

            <!--Tax-->
            <Grid Grid.Row="8" Margin="10,20">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <TextBlock Text="Tax State Tax 10%" FontWeight="Bold"/>
                <TextBlock Grid.Column="1" Text="{x:Bind FormatAmount(ViewModel.TotalTax),Mode=OneWay}" FontWeight="Bold" HorizontalAlignment="Right"/>
            </Grid>

            <!--Pay-->

            <Grid  Grid.Row="9" Background="LightGray" Padding="20">
                <Button Click="PayButton_Click" CornerRadius="5" HorizontalContentAlignment="Stretch" Height="50" HorizontalAlignment="Stretch" BorderThickness="0" Style="{StaticResource PayButtonStyle}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="Pay" FontSize="18" FontWeight="SemiBold"/>
                            <TextBlock Margin="10,0" VerticalAlignment="Center" Text="{x:Bind ViewModel.SaleCountTxt, Mode=OneWay}" FontSize="12" Opacity="0.8"/>
                        </StackPanel>
                        <TextBlock HorizontalAlignment="Right" Grid.Column="1" Text="{x:Bind FormatAmount(ViewModel.SaleTotal),Mode=OneWay}" FontSize="18" FontWeight="Bold" VerticalAlignment="Bottom"/>
                    </Grid>
                </Button>

            </Grid>
        </Grid>
    </Grid>
</Page>
